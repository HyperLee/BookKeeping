@page
@model BookKeeping.Pages.Transactions.CreateModel
@{
    ViewData["Title"] = "新增收支紀錄";
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <h2 class="mb-4">@ViewData["Title"]</h2>

            <form method="post" id="transactionForm">
                <div class="mb-3">
                    <label asp-for="Input.Date" class="form-label">日期</label>
                    <input asp-for="Input.Date" class="form-control" type="date" />
                    <span asp-validation-for="Input.Date" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="Input.Amount" class="form-label">金額</label>
                    <input asp-for="Input.Amount" class="form-control" type="number" step="0.01" min="0.01" />
                    <span asp-validation-for="Input.Amount" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label class="form-label">類型</label>
                    <div>
                        <div class="form-check form-check-inline">
                            <input asp-for="Input.Type" class="form-check-input" type="radio" value="@TransactionType.Expense" id="typeExpense" checked />
                            <label class="form-check-label" for="typeExpense">
                                支出
                            </label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input asp-for="Input.Type" class="form-check-input" type="radio" value="@TransactionType.Income" id="typeIncome" />
                            <label class="form-check-label" for="typeIncome">
                                收入
                            </label>
                        </div>
                    </div>
                    <span asp-validation-for="Input.Type" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="Input.CategoryId" class="form-label">分類</label>
                    <select asp-for="Input.CategoryId" class="form-select" id="categorySelect">
                        <option value="">請選擇分類</option>
                        <optgroup label="支出" id="expenseCategories">
                            @foreach (var category in Model.ExpenseCategories)
                            {
                                <option value="@category.Id">@category.Icon @category.Name</option>
                            }
                        </optgroup>
                        <optgroup label="收入" id="incomeCategories" style="display:none;">
                            @foreach (var category in Model.IncomeCategories)
                            {
                                <option value="@category.Id">@category.Icon @category.Name</option>
                            }
                        </optgroup>
                    </select>
                    <span asp-validation-for="Input.CategoryId" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="Input.AccountId" class="form-label">帳戶</label>
                    <select asp-for="Input.AccountId" class="form-select">
                        <option value="">請選擇帳戶</option>
                        @foreach (var account in Model.Accounts)
                        {
                            <option value="@account.Id">@account.Icon @account.Name</option>
                        }
                    </select>
                    <span asp-validation-for="Input.AccountId" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="Input.Note" class="form-label">備註</label>
                    <textarea asp-for="Input.Note" class="form-control" rows="3" maxlength="500"></textarea>
                    <span asp-validation-for="Input.Note" class="text-danger"></span>
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <a asp-page="/Transactions/Index" class="btn btn-secondary">取消</a>
                    <button type="submit" class="btn btn-primary" id="submitButton">儲存</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        $(document).ready(function() {
            // Toggle category options based on transaction type
            $('input[name="Input.Type"]').change(function() {
                var type = $(this).val();
                if (type == '@((int)TransactionType.Expense)') {
                    $('#expenseCategories').show();
                    $('#incomeCategories').hide();
                } else {
                    $('#expenseCategories').hide();
                    $('#incomeCategories').show();
                }
                $('#categorySelect').val('');
            });

            // Anti-duplicate submission guard
            $('#transactionForm').submit(function() {
                $('#submitButton').prop('disabled', true).text('處理中...');
            });

            // Re-enable button on validation error
            if ($('.text-danger').text().trim().length > 0) {
                $('#submitButton').prop('disabled', false).text('儲存');
            }
        });
    </script>
}
