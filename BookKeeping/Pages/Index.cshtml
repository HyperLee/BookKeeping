@page
@using System.Globalization
@model IndexModel
@{
    ViewData["Title"] = "儀表板";
}

<div class="container mt-4">
    <h2 class="mb-4">@ViewData["Title"]</h2>

    <!-- Monthly Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <h5 class="card-title">本月收入</h5>
                    <h2 class="card-text">$@Model.ViewModel.TotalIncome.ToString("N2")</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-danger">
                <div class="card-body">
                    <h5 class="card-title">本月支出</h5>
                    <h2 class="card-text">$@Model.ViewModel.TotalExpense.ToString("N2")</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white @(Model.ViewModel.Balance >= 0 ? "bg-primary" : "bg-warning")">
                <div class="card-body">
                    <h5 class="card-title">結餘</h5>
                    <h2 class="card-text">$@Model.ViewModel.Balance.ToString("N2")</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Account Balances -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">帳戶餘額</h5>
                </div>
                <div class="card-body">
                    @if (Model.ViewModel.AccountBalances.Any())
                    {
                        <ul class="list-group list-group-flush">
                            @foreach (var account in Model.ViewModel.AccountBalances)
                            {
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>@account.Icon @account.Name</span>
                                    <strong class="@(account.CurrentBalance >= 0 ? "text-success" : "text-danger")">
                                        $@account.CurrentBalance.ToString("N2")
                                    </strong>
                                </li>
                            }
                        </ul>
                    }
                    else
                    {
                        <p class="text-muted mb-0">尚無帳戶</p>
                    }
                </div>
            </div>
        </div>

        <!-- Recent Transactions -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">最近交易</h5>
                    <a asp-page="/Transactions/Index" class="btn btn-sm btn-outline-primary">查看全部</a>
                </div>
                <div class="card-body">
                    @if (Model.ViewModel.RecentTransactions.Any())
                    {
                        <ul class="list-group list-group-flush">
                            @foreach (var transaction in Model.ViewModel.RecentTransactions)
                            {
                                <li class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <span>@transaction.CategoryIcon @transaction.CategoryName</span>
                                            <small class="text-muted d-block">@transaction.Date.ToString("yyyy-MM-dd")</small>
                                        </div>
                                        <strong class="@(transaction.Type == TransactionType.Income ? "text-success" : "text-danger")">
                                            @(transaction.Type == TransactionType.Income ? "+" : "-")$@transaction.Amount.ToString("N2")
                                        </strong>
                                    </div>
                                </li>
                            }
                        </ul>
                    }
                    else
                    {
                        <p class="text-muted mb-0">尚無交易紀錄</p>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Budget Progress -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">預算進度</h5>
            <a asp-page="/Budgets/Index" class="btn btn-sm btn-outline-primary">管理預算</a>
        </div>
        <div class="card-body">
            @if (Model.ViewModel.BudgetProgress.Any())
            {
                @foreach (var budget in Model.ViewModel.BudgetProgress)
                {
                    var progressClass = budget.Status switch
                    {
                        "warning" => "bg-warning",
                        "exceeded" => "bg-danger",
                        _ => "bg-success"
                    };
                    var statusBadgeClass = budget.Status switch
                    {
                        "warning" => "bg-warning text-dark",
                        "exceeded" => "bg-danger",
                        _ => "bg-success"
                    };
                    var statusLabel = budget.Status switch
                    {
                        "warning" => "接近上限",
                        "exceeded" => "超出預算",
                        _ => "正常"
                    };
                    var progressWidth = budget.UsageRate > 100m ? 100m : budget.UsageRate;

                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>@budget.CategoryIcon @budget.CategoryName</span>
                            <span class="badge @statusBadgeClass">@statusLabel</span>
                        </div>
                        <div class="progress mt-1" style="height: 0.9rem;">
                            <div class="progress-bar @progressClass"
                                 role="progressbar"
                                 style="width: @progressWidth.ToString("0.##", CultureInfo.InvariantCulture)%;"
                                 aria-valuenow="@budget.UsageRate"
                                 aria-valuemin="0"
                                 aria-valuemax="100"></div>
                        </div>
                        <small class="text-muted">$@budget.SpentAmount.ToString("N2") / $@budget.BudgetAmount.ToString("N2")（@budget.UsageRate.ToString("0.##")%）</small>
                    </div>
                }
            }
            else
            {
                <p class="text-muted mb-0">尚未設定預算。</p>
            }
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="text-center">
        <a asp-page="/Transactions/Create" class="btn btn-primary btn-lg">新增收支</a>
    </div>
</div>
