# Feature Specification: Open BookKeeping — 開源個人記帳理財工具

**Feature Branch**: `001-open-bookkeeping-core`  
**Created**: 2026-02-20  
**Status**: Draft  
**Input**: User description: "開源個人記帳理財工具 MVP — 包含收支紀錄管理、分類系統、月度摘要、視覺化圖表、預算追蹤、CSV 匯出匯入、本地資料儲存"

## User Scenarios & Testing *(mandatory)*

### User Story 1 — 新增收支紀錄 (Priority: P1)

使用者開啟 App 後，能快速新增一筆收入或支出紀錄，填寫金額、選擇分類、指定帳戶、輸入備註，儲存後立即在明細列表中看到該筆紀錄。此為記帳工具最基礎的核心操作。

**Why this priority**: 沒有新增紀錄的能力，整個工具無法運作。這是所有其他功能（報表、預算、匯出）的資料來源。

**Independent Test**: 開啟 App → 點擊新增 → 填寫一筆 $150 餐飲支出 → 儲存 → 在明細列表中確認該筆紀錄正確顯示。

**Acceptance Scenarios**:

1. **Given** 使用者首次開啟 App，**When** 新增一筆 $150 的「餐飲」支出並儲存，**Then** 紀錄正確儲存並顯示在明細列表中，包含日期、金額、分類、帳戶、備註
2. **Given** 使用者已有紀錄，**When** 點擊某筆紀錄進行編輯並修改金額為 $200，**Then** 明細列表中該筆紀錄金額更新為 $200
3. **Given** 使用者已有紀錄，**When** 刪除一筆紀錄並確認，**Then** 該筆紀錄從明細列表中移除
4. **Given** 使用者新增紀錄，**When** 未填寫金額即按儲存，**Then** 顯示驗證提示，不允許儲存

---

### User Story 2 — 本地資料持久化 (Priority: P1)

使用者的所有收支紀錄、分類設定、帳戶資訊皆儲存在本機裝置上。關閉瀏覽器後重新開啟，所有資料仍然完整存在，無需登入或雲端同步。

**Why this priority**: 資料持久化是記帳工具的生命線。若關閉瀏覽器後資料消失，工具毫無價值。與 P1-新增紀錄同為最核心需求。

**Independent Test**: 新增數筆紀錄 → 關閉瀏覽器 → 重新開啟 App → 確認所有紀錄仍然存在且正確。

**Acceptance Scenarios**:

1. **Given** 使用者已新增 10 筆收支紀錄，**When** 關閉瀏覽器後重新開啟 App，**Then** 所有 10 筆紀錄完整保留，資料內容不變
2. **Given** 使用者修改了分類設定（新增自訂分類），**When** 重新開啟 App，**Then** 自訂分類設定仍然存在
3. **Given** 使用者清除瀏覽器快取（非清除站台資料），**When** 重新開啟 App，**Then** 資料仍然完整保留

---

### User Story 3 — 收支分類管理 (Priority: P1)

系統提供預設收支分類（餐飲、交通、娛樂、購物、居住、醫療等），使用者也能新增、編輯、刪除自訂分類。每個分類有名稱、圖示和類型（收入/支出）。

**Why this priority**: 分類是記帳工具的基礎結構，影響新增紀錄、報表統計、預算設定等所有功能模組。

**Independent Test**: 開啟 App → 確認預設分類已存在 → 新增一個自訂分類「寵物」 → 新增紀錄時確認可選擇該分類。

**Acceptance Scenarios**:

1. **Given** 使用者首次開啟 App，**When** 進入新增紀錄畫面，**Then** 可選擇預設分類（至少包含：餐飲、交通、娛樂、購物、居住、醫療、教育、薪資）
2. **Given** 使用者進入分類管理頁面，**When** 新增名為「寵物」的支出分類，**Then** 該分類出現在分類列表和新增紀錄的分類選項中
3. **Given** 某分類已被紀錄使用，**When** 嘗試刪除該分類，**Then** 系統提示該分類正在使用中，詢問是否將相關紀錄移至其他分類

---

### User Story 4 — 月度收支摘要與視覺化圖表 (Priority: P2)

使用者能查看特定月份的收支摘要，包含總收入、總支出、結餘金額。同時以圓餅圖顯示支出分類佔比，以趨勢圖顯示每日或每月收支變化。

**Why this priority**: 報表是記帳的「回饋迴圈」——讓使用者看到自己花費的全貌，是促使持續記帳的關鍵動力。依賴 P1 的紀錄資料。

**Independent Test**: 預先輸入 30 天的收支資料 → 切換至報表頁 → 確認月度摘要數字正確、圓餅圖分類佔比正確、趨勢圖資料點正確。

**Acceptance Scenarios**:

1. **Given** 有 30 天的收支紀錄，**When** 查看該月月報，**Then** 正確顯示總收入、總支出、結餘金額
2. **Given** 有多個分類的支出紀錄，**When** 查看月報的分類圓餅圖，**Then** 各分類佔比正確且總和為 100%
3. **Given** 有 30 天的每日支出紀錄，**When** 查看趨勢圖，**Then** 每日支出金額正確標示在圖表上
4. **Given** 某月份沒有任何紀錄，**When** 查看該月月報，**Then** 顯示「本月尚無紀錄」提示，圖表區域為空白或顯示引導新增紀錄

---

### User Story 5 — 預算設定與追蹤 (Priority: P2)

使用者能為特定支出分類設定每月預算金額。系統自動追蹤各分類的花費進度，當接近或超出預算時顯示提醒。Dashboard 上以進度條呈現預算使用率。

**Why this priority**: 預算功能是記帳工具最核心的差異化功能之一。驗收標準已明確包含預算超支提示的測試案例。依賴 P1 的紀錄與分類。

**Independent Test**: 設定餐飲月預算 $5,000 → 陸續新增餐飲支出至超過 $5,000 → 確認超支提示出現且 Dashboard 進度條正確顯示。

**Acceptance Scenarios**:

1. **Given** 使用者設定「餐飲」月預算 $5,000，**When** 餐飲支出累計達 $4,000（80%），**Then** 顯示「接近上限」的提醒
2. **Given** 使用者設定「餐飲」月預算 $5,000，**When** 餐飲支出累計超過 $5,000，**Then** 顯示「超出預算」的警告（例如：「本月餐飲已超出預算 $2,000（預算 $5,000 / 已花 $7,000）」）
3. **Given** 使用者設定多個分類預算，**When** 進入 Dashboard，**Then** 各分類皆以進度條顯示預算使用率（百分比）
4. **Given** 新的月份開始，**When** 查看預算追蹤，**Then** 各分類花費自動歸零重新計算

---

### User Story 6 — CSV 匯出 (Priority: P2)

使用者能將收支紀錄匯出為 CSV 格式檔案，供備份或在試算表軟體（如 Excel）中使用。匯出時可選擇日期範圍。

**Why this priority**: 匯出是資料自主權的關鍵保障，讓使用者的資料不被鎖死在工具中。在驗收標準中為必測項目。

**Independent Test**: 新增 100 筆紀錄 → 點擊匯出 → 下載 CSV → 以 Excel 開啟確認欄位完整且格式正確。

**Acceptance Scenarios**:

1. **Given** 使用者有 100 筆紀錄，**When** 點擊 CSV 匯出（不指定範圍），**Then** 下載的 CSV 包含所有 100 筆紀錄，欄位為：日期、類型、金額、分類、帳戶、備註
2. **Given** 使用者有 2026 年 1 月和 2 月的紀錄，**When** 選擇匯出 2 月份資料，**Then** CSV 僅包含 2 月份的紀錄
3. **Given** 紀錄的備註欄位包含逗號或換行，**When** 匯出 CSV，**Then** 該欄位正確以引號包覆，不影響 CSV 解析

---

### User Story 7 — CSV 匯入 (Priority: P3)

使用者能匯入標準格式的 CSV 檔案，批次建立收支紀錄。V1 支援固定欄位格式（日期、類型、金額、分類、帳戶、備註）。

**Why this priority**: 匯入可減少手動輸入的負擔，但非第一天就必要。V1 先支援標準格式，銀行對帳單格式留待後續版本。

**Independent Test**: 準備一個包含 10 筆紀錄的標準格式 CSV → 匯入 → 確認 10 筆紀錄全部正確建立。

**Acceptance Scenarios**:

1. **Given** 使用者準備了一份標準格式 CSV（欄位：日期,類型,金額,分類,帳戶,備註），**When** 上傳並匯入，**Then** 所有紀錄正確建立並顯示在明細列表中
2. **Given** CSV 中某行的日期格式錯誤（如 "2026/13/01"），**When** 匯入時，**Then** 跳過該筆錯誤紀錄並告知使用者「第 N 行匯入失敗：日期格式無效」
3. **Given** CSV 中的分類在系統中不存在，**When** 匯入時，**Then** 自動建立該分類或提示使用者選擇對應分類

---

### User Story 8 — 搜尋與篩選 (Priority: P3)

使用者能在明細列表中搜尋紀錄（依關鍵字）、篩選紀錄（依日期範圍、分類、帳戶、金額範圍）以快速找到特定紀錄。

**Why this priority**: 隨著紀錄增多，搜尋篩選對使用者體驗至關重要。但初期紀錄較少時，手動瀏覽即可。

**Independent Test**: 建立 50 筆不同分類和日期的紀錄 → 使用分類篩選 → 確認僅顯示該分類的紀錄 → 使用關鍵字搜尋備註 → 確認正確匹配。

**Acceptance Scenarios**:

1. **Given** 有 50 筆紀錄，**When** 選擇「餐飲」分類篩選，**Then** 僅顯示分類為餐飲的紀錄
2. **Given** 有 50 筆紀錄，**When** 設定日期範圍為 2026-02-01 到 2026-02-15，**Then** 僅顯示該範圍內的紀錄
3. **Given** 有一筆備註為「午餐便當」的紀錄，**When** 在搜尋欄輸入「便當」，**Then** 該筆紀錄出現在搜尋結果中

---

### Edge Cases

- 金額輸入 0 或負數時，系統應拒絕並顯示驗證錯誤
- 日期選擇未來日期時，系統應允許（預填記帳場景）但可提示確認
- 使用者在同一秒內快速連按兩次「儲存」時，應防止重複建立紀錄
- 瀏覽器的 IndexedDB 容量即將滿時，應提前警告使用者備份資料
- 當分類被刪除但仍有紀錄引用時，顯示的紀錄不應因分類缺失而出錯
- 匯入 CSV 檔案為空（僅有標題列）時，應提示「無有效資料」而非報錯
- 月報查詢跨年時（如從 12 月看到 1 月），日期邊界的紀錄歸屬應正確
- 大量紀錄（超過 10,000 筆）時，明細列表與圖表應維持可接受的載入速度
- 使用者以不同瀏覽器開啟同一站台時，各瀏覽器的資料互相獨立（本地儲存特性）

## Requirements *(mandatory)*

### Functional Requirements

**紀錄管理**

- **FR-001**: 系統 MUST 允許使用者新增收支紀錄，包含以下欄位：日期、金額（正數）、類型（收入/支出）、分類、帳戶、備註
- **FR-002**: 系統 MUST 允許使用者編輯已存在的收支紀錄的所有欄位
- **FR-003**: 系統 MUST 允許使用者刪除收支紀錄，刪除前需二次確認
- **FR-004**: 系統 MUST 在儲存紀錄前驗證資料完整性（金額為正數、日期為有效 ISO 8601 格式 YYYY-MM-DD、分類已選擇）
- **FR-005**: 系統 MUST 自動記錄每筆紀錄的建立時間和最後更新時間

**分類系統**

- **FR-006**: 系統 MUST 在首次使用時自動建立預設支出分類：餐飲、交通、娛樂、購物、居住、醫療、教育、其他
- **FR-007**: 系統 MUST 在首次使用時自動建立預設收入分類：薪資、獎金、投資收益、其他收入
- **FR-008**: 系統 MUST 允許使用者新增、編輯、刪除自訂分類，每個分類包含名稱、圖示（emoji）、類型（收入/支出）
- **FR-009**: 系統 MUST 防止刪除仍有紀錄關聯的分類，或提供將關聯紀錄遷移至其他分類的選項

**帳戶標記**

- **FR-010**: 系統 MUST 提供帳戶欄位供使用者標記紀錄的資金來源（如：現金、銀行、信用卡、電子支付）
- **FR-011**: 系統 MUST 允許使用者新增和管理帳戶（名稱、類型、圖示），V1 不實作帳戶間轉帳

**月度摘要與報表**

- **FR-012**: 系統 MUST 計算並顯示指定月份的總收入、總支出、結餘（收入 - 支出）
- **FR-013**: 系統 MUST 以圓餅圖顯示指定月份各支出分類的金額佔比
- **FR-014**: 系統 MUST 以趨勢圖顯示每日或每月的收支金額變化
- **FR-015**: 系統 MUST 在無資料的月份顯示友善的空白狀態提示

**預算管理**

- **FR-016**: 系統 MUST 允許使用者為特定支出分類設定每月預算金額
- **FR-017**: 系統 MUST 即時計算各分類的預算使用率（當月已花金額 / 預算金額）
- **FR-018**: 系統 MUST 在預算使用率達到 80% 時顯示「接近上限」提醒
- **FR-019**: 系統 MUST 在預算使用率超過 100% 時顯示「超出預算」警告，包含超出金額
- **FR-020**: 系統 MUST 在新增支出紀錄後自動檢查對應分類的預算狀態並即時回饋

**資料匯出匯入**

- **FR-021**: 系統 MUST 允許使用者將收支紀錄匯出為 CSV 格式（欄位：日期(YYYY-MM-DD),類型,金額,分類,帳戶,備註）
- **FR-022**: 系統 MUST 支援匯出時選擇日期範圍篩選
- **FR-023**: 系統 MUST 正確處理 CSV 中的特殊字元（逗號、引號、換行）
- **FR-024**: 系統 MUST 允許使用者匯入標準格式 CSV（V1 固定欄位順序：日期(YYYY-MM-DD),類型,金額,分類,帳戶,備註）
- **FR-025**: 系統 MUST 在匯入時逐行驗證資料，跳過錯誤行並回報具體錯誤原因（行號與錯誤訊息）
- **FR-034**: 系統 MUST 限制 CSV 匯入檔案大小上限為 5MB，單次匯入筆數上限為 10,000 筆，超過時顯示明確錯誤訊息
- **FR-035**: 系統 MUST 對 CSV 匯入的所有文字欄位（備註、分類名稱、帳戶名稱）執行 HTML sanitize，移除潛在的 XSS 攻擊向量

**資料儲存與隱私**

- **FR-026**: 系統 MUST 將所有使用者資料儲存在本機（交易紀錄、帳戶、分類使用 IndexedDB；設定使用 LocalStorage）
- **FR-027**: 系統 MUST 確保零資料上傳，所有資料僅存在於使用者裝置上
- **FR-028**: 系統 MUST 在瀏覽器關閉後重新開啟時完整還原所有資料
- **FR-033**: 系統 MUST 實作 IndexedDB schema 版本化遷移框架（包含 DB version number 與逐版遷移腳本），確保未來版本升級時自動遷移現有資料而不需使用者介入

**搜尋與篩選**

- **FR-029**: 系統 MUST 提供依日期範圍、分類、帳戶、金額範圍篩選紀錄的功能
- **FR-030**: 系統 MUST 提供關鍵字搜尋功能，搜尋範圍涵蓋備註欄位

**介面與導覽**

- **FR-031**: 系統 MUST 提供底部導覽列，包含：首頁（Dashboard）、明細、新增、報表、更多（設定）
- **FR-032**: 系統 MUST 在 Dashboard 顯示本月摘要（收入/支出/結餘）、預算進度條、最近紀錄

### Key Entities

- **Transaction（交易紀錄）**: 每一筆收入或支出的記錄。關鍵屬性：唯一識別碼、日期、金額（正數）、類型（收入/支出）、分類、帳戶、備註、建立時間、更新時間。與 Category 和 Account 有關聯。
- **Category（分類）**: 交易紀錄的分類標籤。關鍵屬性：唯一識別碼、名稱、圖示（emoji）、類型（收入/支出）、顏色、排序順序、是否為預設。可被多筆 Transaction 引用，也可被 Budget 引用。
- **Account（帳戶）**: 資金來源的標記。關鍵屬性：唯一識別碼、名稱、類型（現金/銀行/信用卡/電子支付）、圖示、初始餘額、幣別。可被多筆 Transaction 引用。
- **Budget（預算）**: 特定分類的花費上限。關鍵屬性：唯一識別碼、關聯分類、預算金額、週期（月/週）、起始日。與 Category 有關聯。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 使用者能在 30 秒內完成一筆收支紀錄的新增（從點擊新增到儲存成功）
- **SC-002**: 100 筆紀錄的月度摘要與圓餅圖能在 2 秒內完成載入與渲染
- **SC-003**: 匯出 1,000 筆紀錄的 CSV 能在 5 秒內完成下載，且檔案可被 Excel 正確開啟
- **SC-004**: 匯入 100 筆紀錄的 CSV 能在 10 秒內完成處理，並清楚回報成功/失敗筆數
- **SC-005**: 預算超支提醒在新增紀錄後 1 秒內顯示，使用者不需手動重新整理
- **SC-006**: 關閉瀏覽器後重新開啟 App，資料還原成功率為 100%（在使用者未清除站台資料的前提下）
- **SC-007**: 累積超過 10,000 筆紀錄時，明細列表的滾動與篩選仍維持流暢（無明顯卡頓）
- **SC-008**: 90% 的首次使用者能在無需說明文件的情況下成功完成第一筆記帳
- **SC-009**: 所有使用者資料零上傳，本地儲存機制通過隱私審查（無外部網路請求傳送使用者資料）

## Clarifications

### Session 2026-02-20

- Q: 前端技術架構：規格要求靜態部署與 IndexedDB，但工作區為 Razor Pages，如何解決矛盾？ → A: 改用 Blazor WebAssembly — 純前端 SPA，保留 C# 技術堆疊，可靜態部署至 GitHub Pages，支援 IndexedDB
- Q: Transaction 實體包含「標籤」屬性，但功能需求中未定義任何標籤功能，是否保留？ → A: V1 移除標籤欄位，減少範圍；V2 再考慮
- Q: IndexedDB schema 版本遷移策略——V1 是否需預先建立遷移機制以確保 V2 升級相容？ → A: V1 建立基礎遷移框架（DB version number + 遷移腳本機制），自動升級 schema
- Q: CSV 匯入的安全防護策略——是否需防範惡意/超大檔案？ → A: 基礎防護——檔案大小上限 5MB、單次匯入上限 10,000 筆、文字欄位 HTML sanitize
- Q: 日期格式標準——內部儲存、CSV 與 UI 應採用何種日期格式？ → A: ISO 8601 (YYYY-MM-DD)——內部儲存與 CSV 使用 ISO 格式，UI 顯示可本地化

## Assumptions

- 前端框架採用 Blazor WebAssembly（.NET），編譯為純前端靜態應用，部署至 GitHub Pages 等靜態伺服器
- 使用者使用的是現代瀏覽器（Chrome、Firefox、Safari、Edge 的近兩個主要版本），且瀏覽器支援 IndexedDB
- V1 為單一幣別（使用者在初始設定中選擇），多幣別支援留待後續版本
- V1 不實作帳戶間轉帳邏輯，帳戶僅做為紀錄的標記欄位
- V1 不需要使用者登入或帳號系統
- CSV 匯入的標準格式為固定六欄位順序（日期,類型,金額,分類,帳戶,備註），銀行對帳單欄位對映留待 V2
- 金額一律以正數儲存，收入/支出由 type 欄位區分
- 日期內部儲存與 CSV 匯出匯入統一採用 ISO 8601 格式 (YYYY-MM-DD)，UI 顯示可依使用者幣別/語系做本地化轉換
- 預算週期以月為最小單位，週預算為加分項
- 應用部署目標為靜態網頁伺服器（如 GitHub Pages），採用 Blazor WebAssembly 純前端架構，不依賴後端服務
- 資料量預估：一般使用者每月 50-200 筆紀錄，積累一年約 600-2,400 筆
